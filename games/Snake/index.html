<html><head><base href="." />
<style>
  /* Enhanced Pixelated font face */
  @font-face {
    font-family: 'Press Start 2P';
    src: url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  }

  body {
    margin: 0;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background: #1a1a1a;
    perspective: 1000px;
  }

  .title-container {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
  }

  .title {
    color: #ff6633; /* Changed from #3366ff */
    font-family: 'Press Start 2P', monospace;
    font-size: 28px;
    text-transform: uppercase;
    letter-spacing: 3px;
    text-shadow: 
      0 0 10px rgba(255,102,51,0.5), /* Changed from rgba(51,102,255,0.5) */
      2px 2px 0 #1a1a1a,
      4px 4px 0 rgba(255,102,51,0.3), /* Changed from rgba(51,102,255,0.3) */
      6px 6px 0 rgba(255,102,51,0.2); /* Changed from rgba(51,102,255,0.2) */
    animation: pixelFloat 3s steps(5) infinite;
    image-rendering: pixelated;
    -webkit-font-smooth: none;
    position: relative;
  }

  .title::before {
    content: 'MULTIPLAYER HANGOUT BASEPLATE';
    position: absolute;
    left: -3px;
    top: -3px;
    color: #ff3366;
    opacity: 0.5;
    z-index: -1;
    animation: glitchEffect 2s steps(2) infinite;
  }

  @keyframes pixelFloat {
    0% {
      transform: translateY(0px) rotate(-2deg);
    }
    25% {
      transform: translateY(-5px) rotate(0deg);
    }
    50% {
      transform: translateY(-10px) rotate(2deg);
    }
    75% {
      transform: translateY(-5px) rotate(0deg);
    }
    100% {
      transform: translateY(0px) rotate(-2deg);
    }
  }

  @keyframes glitchEffect {
    0% {
      transform: translate(0);
    }
    20% {
      transform: translate(-2px, 2px);
    }
    40% {
      transform: translate(-2px, -2px);
    }
    60% {
      transform: translate(2px, 2px);
    }
    80% {
      transform: translate(2px, -2px);
    }
    100% {
      transform: translate(0);
    }
  }

  /* New player username styles */
  .player-username {
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    color: white;
    font-family: 'Press Start 2P', monospace;
    font-size: 12px;
    white-space: nowrap;
    text-shadow: 2px 2px 2px rgba(0,0,0,0.8);
    pointer-events: none;
  }

  /* Rest of existing styles */
  .baseplate {
    width: 400px;
    height: 400px;
    position: relative;
    transform-style: preserve-3d;
    transform: rotateX(60deg) rotateZ(45deg);
  }

  .grid {
    position: absolute;
    width: 100%;
    height: 100%;
    display: grid;
    grid-template-columns: repeat(16, 1fr);
    grid-template-rows: repeat(16, 1fr);
    gap: 2px;
    background: #2a2a2a;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
  }

  .pixel {
    background: #3a3a3a;
    transition: all 0.3s ease;
  }

  .player {
    width: 20px;
    height: 20px;
    background: #ff6633; /* Changed from #3366ff */
    border-radius: 50%;
    position: absolute;
    transform-style: preserve-3d;
    transform: translate(-50%, -50%) translateZ(10px);
    box-shadow: 0 5px 15px rgba(255,102,51,0.3); /* Changed from rgba(51,102,255,0.3) */
    transition: transform 0.2s ease;
  }

  .other-player {
    width: 20px;
    height: 20px;
    background: #33ff66; /* Green color for other players */
    border-radius: 50%;
    position: absolute;
    transform-style: preserve-3d;
    transform: translate(-50%, -50%) translateZ(10px);
    box-shadow: 0 5px 15px rgba(51,255,102,0.3);
    transition: transform 0.2s ease;
  }

  .controls {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,255,0.1);
    padding: 10px;
    border-radius: 5px;
    color: white;
    font-family: Arial, sans-serif;
  }

  .mobile-controls {
    display: none;
    position: fixed;
    bottom: 20px; /* Changed from 100px to 20px */
    left: 50%;
    transform: translateX(-50%);
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    gap: 10px;
    z-index: 1000;
    touch-action: none;
    width: 170px; /* Width for 3 buttons across */
  }

  /* Position up button to span the top row */
  #upBtn {
    grid-column: 2;
    grid-row: 1;
  }

  /* Position left button on bottom left */
  #leftBtn {
    grid-column: 1;
    grid-row: 2;
  }

  /* Position down button on bottom middle */
  #downBtn {
    grid-column: 2;
    grid-row: 2;
  }

  /* Position right button on bottom right */
  #rightBtn {
    grid-column: 3;
    grid-row: 2;
  }

  /* Position dash button on bottom center */
  #dashBtn {
    grid-column: 2;
    grid-row: 3;
    background: rgba(255, 51, 102, 0.3);
    border: 2px solid rgba(255, 51, 102, 0.5);
    font-size: 14px;
  }

  #dashBtn:active {
    background: rgba(255, 51, 102, 0.5);
    transform: scale(0.95);
  }

  .mobile-controls.active {
    display: grid;
  }

  .mobile-btn {
    width: 50px; /* Reduced from 70px */
    height: 50px; /* Reduced from 70px */
    background: rgba(255,102,51,0.3); /* Changed from rgba(51,102,255,0.3) */
    border: 2px solid rgba(255,102,51,0.5); /* Changed from rgba(51,102,255,0.5) */
    border-radius: 50%;
    color: white;
    font-size: 20px; /* Reduced from 28px */
    cursor: pointer;
    touch-action: manipulation;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
  }

  .mobile-btn:active {
    background: rgba(255,102,51,0.5); /* Changed from rgba(51,102,255,0.5) */
    transform: scale(0.95);
  }

  #toggleMobile {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 24px;
    background: rgba(255,102,51,0.4); /* Changed from rgba(51,102,255,0.4) */
    border: 2px solid rgba(255,102,51,0.6); /* Changed from rgba(51,102,255,0.6) */
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-family: 'Press Start 2P', monospace;
    font-size: 14px;
    transition: all 0.2s ease;
    z-index: 1001;
  }

  #toggleMobile:active {
    transform: scale(0.95);
  }

  /* Update admin panel button styles */
  .admin-panel-btn {
    position: fixed;
    bottom: 20px; /* Change from top to bottom */
    right: 20px; /* Keep at 20px from right */
    padding: 12px 24px;
    background: rgba(255,102,51,0.4);
    border: 2px solid rgba(255,102,51,0.6);
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-family: 'Press Start 2P', monospace;
    font-size: 14px;
    transition: all 0.2s ease;
    z-index: 1001;
  }

  .admin-panel {
    display: none;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: rgba(26, 26, 26, 0.95);
    border: 2px solid #ff6633;
    border-radius: 10px;
    padding: 20px;
    min-width: 300px;
    color: white;
    font-family: 'Press Start 2P', monospace;
    z-index: 1100;
  }

  .admin-panel h2 {
    margin-bottom: 20px;
    color: #ff6633;
  }

  .admin-panel-close {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
  }

  /* Styles for admin buttons */
  .admin-btn {
    display: block;
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    background: rgba(255,102,51,0.3);
    border: 2px solid rgba(255,102,51,0.6);
    border-radius: 5px;
    color: white;
    cursor: pointer;
    font-family: 'Press Start 2P', monospace;
    font-size: 12px;
    transition: all 0.2s ease;
  }

  .admin-btn:hover {
    background: rgba(255,102,51,0.5);
  }

  .audio-controls {
    position: fixed;
    top: 20px;
    left: 20px;
    display: flex;
    gap: 10px;
  }

  .audio-btn {
    padding: 10px 20px;
    background: rgba(255,102,51,0.3); /* Changed from rgba(51,102,255,0.3) */
    border: none;
    border-radius: 5px;
    color: white;
    cursor: pointer;
    font-family: Arial, sans-serif;
    transition: background 0.3s ease;
  }

  .audio-btn:hover {
    background: rgba(255,102,51,0.5); /* Changed from rgba(51,102,255,0.5) */
  }

  .audio-btn.playing {
    background: rgba(255,51,51,0.3);
  }

  /* Chat styles */
  .chat-container {
    position: fixed;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    width: 250px; /* Reduced from 300px */
    height: 400px; /* Reduced from 500px */
    background: rgba(26, 26, 26, 0.9);
    border: 2px solid #ff6633; /* Changed from #3366ff */
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    padding: 8px; /* Reduced from 10px */
    font-family: 'Press Start 2P', monospace;
    box-shadow: 0 0 20px rgba(255,102,51,0.2); /* Changed from rgba(51,102,255,0.2) */
  }

  .chat-shop-btn {
    background: #ff6633; /* Changed from #3366ff */
    border: none;
    border-radius: 5px;
    color: white;
    padding: 5px 10px;
    margin-bottom: 5px;
    cursor: pointer;
    font-family: 'Press Start 2P', monospace;
    font-size: 10px;
    transition: background 0.3s ease;
  }

  .chat-shop {
    position: fixed;
    right: 290px;
    top: 50%;
    transform: translateY(-50%);
    width: 300px;
    background: rgba(26, 26, 26, 0.95);
    border: 2px solid #ff6633; /* Changed from #3366ff */
    border-radius: 10px;
    padding: 15px;
    color: white;
    font-family: 'Press Start 2P', monospace;
    z-index: 1000;
  }

  .shop-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }

  .shop-close {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
  }

  .shop-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border: 1px solid #ff6633; /* Changed from #3366ff */
    margin-bottom: 10px;
    border-radius: 5px;
  }

  .shop-item button {
    background: #ff6633; /* Changed from #3366ff */
    border: none;
    border-radius: 5px;
    color: white;
    padding: 5px 10px;
    cursor: pointer;
  }

  .shop-item button:disabled {
    background: #666;
    cursor: not-allowed;
  }

  .shop-item.owned button.buy {
    display: none;
  }

  .shop-item.owned button.equip {
    display: block;
  }

  .shop-item button.equip {
    display: none;
    background: #33ff66;
  }

  .shop-item button.equipped {
    background: #ff3366;
  }

  .preview-text {
    margin-right: 10px;
    font-size: 12px;
  }

  .chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    margin-bottom: 10px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    color: #fff;
    font-size: 10px; /* Reduced from 12px */
  }

  .chat-message {
    display: flex;
    flex-direction: column; /* Stack content vertically */
    gap: 5px;
    margin-bottom: 8px;
    max-width: 100%;
  }

  .message-header {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .attachment {
    max-width: 200px; /* Limit width of attachments */
    max-height: 150px; /* Limit height of attachments */
    border-radius: 5px; /* Rounded corners */
    margin-top: 5px;
    object-fit: cover; /* Maintain aspect ratio while fitting in bounds */
  }

  .message-content {
    display: flex;
    flex-direction: column;
    gap: 5px;
    word-break: break-word; /* Prevent long words from overflowing */
    padding-left: 33px; /* Align with username, accounting for avatar width + gap */
  }

  .chat-avatar {
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
    border: 1px solid #ff6633; /* Changed from #3366ff */
  }

  .chat-username {
    color: #ff6633; /* Changed from #3366ff */
    margin-right: 5px;
    font-weight: bold;
  }

  .chat-input-container {
    display: flex;
    gap: 8px;
    align-items: center;
    padding: 8px;
    background: rgba(51, 102, 255, 0.1);
    border-radius: 8px;
    margin-top: 5px;
  }

  .chat-input {
    flex: 1;
    background: rgba(26, 26, 26, 0.8);
    border: 1px solid #ff6633; /* Changed from #3366ff */
    border-radius: 4px;
    padding: 8px 12px;
    color: white;
    font-family: 'Press Start 2P', monospace;
    font-size: 10px;
    outline: none;
    transition: all 0.3s ease;
  }

  .chat-input:focus {
    border-color: #ff3366;
    box-shadow: 0 0 10px rgba(255,102,51,0.2); /* Changed from rgba(51,102,255,0.2) */
  }

  .chat-input::placeholder {
    color: rgba(255, 255, 255, 0.3);
  }

  .file-upload-btn {
    background: rgba(255,102,51,0.2);
    border: 1px solid #ff6633; /* Changed from #3366ff */
    border-radius: 4px;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.3s ease;
  }

  .file-upload-btn:hover {
    background: rgba(255,102,51,0.3);
    transform: translateY(-1px);
  }

  .file-upload-btn:active {
    transform: translateY(1px);
  }

  .chat-send {
    background: #ff6633; /* Changed from #3366ff */
    border: none;
    border-radius: 4px;
    color: white;
    padding: 8px 15px;
    font-family: 'Press Start 2P', monospace;
    font-size: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .chat-send:hover {
    background: #ff3366;
    transform: translateY(-1px);
  }

  .chat-send:active {
    transform: translateY(1px);
  }

  /* Add a nice scrollbar to chat messages */
  .chat-messages::-webkit-scrollbar {
    width: 6px;
  }

  .chat-messages::-webkit-scrollbar-track {
    background: rgba(26, 26, 26, 0.5);
    border-radius: 3px;
  }

  .chat-messages::-webkit-scrollbar-thumb {
    background: #ff6633; /* Changed from #3366ff */
    border-radius: 3px;
  }

  .chat-messages::-webkit-scrollbar-thumb:hover {
    background: #ff3366; /* Changed from #ff3366 */
  }

  .money-display {
    position: fixed;
    top: 70px;
    left: 20px;
    color: #ffd700;
    font-family: 'Press Start 2P', monospace;
    font-size: 16px;
    text-shadow: 2px 2px 0 #000;
  }

  /* New sidebar styles */
  .player-sidebar {
    position: fixed;
    left: 20px;
    top: 120px; /* Position below money display */
    background: rgba(26, 26, 26, 0.9);
    border: 2px solid #ff6633; /* Changed from #3366ff */
    border-radius: 10px;
    padding: 15px;
    color: white;
    font-family: 'Press Start 2P', monospace;
    font-size: 12px;
    min-width: 200px;
    box-shadow: 0 0 20px rgba(255, 102, 51, 0.2); /* Changed from rgba(51, 102, 255, 0.2) */
  }

  .player-list {
    margin-top: 10px;
    list-style: none;
    padding: 0;
  }

  .player-list li {
    margin: 5px 0;
    padding: 5px;
    border-radius: 5px;
    background: rgba(255, 102, 51, 0.1); /* Changed from rgba(51, 102, 255, 0.1) */
    cursor: pointer;  /* Make it look clickable */
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
  }

  .player-list li:hover {
    background: rgba(51, 255, 102, 0.2);
  }

  .player-list li.selected {
    background: rgba(51, 255, 102, 0.3);
    border: 1px solid #33ff66;
  }

  /* Like text styles */
  .like-text {
    position: fixed;
    bottom: 20px;
    left: 20px;
    color: #ff6633; /* Changed from #3366ff */
    font-family: 'Press Start 2P', monospace;
    font-size: 16px; /* Increased from 12px */
    text-shadow: 2px 2px 0 #000;
    animation: likeGlow 2s ease-in-out infinite;
  }

  @keyframes likeGlow {
    0% { opacity: 0.7; }
    50% { opacity: 1; }
    100% { opacity: 0.7; }
  }

  /* Add these styles to the existing <style> section */
  .player-stats-modal {
    display: none;
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: rgba(26, 26, 26, 0.95);
    border: 2px solid #ff6633; /* Changed from #3366ff */
    border-radius: 10px;
    padding: 20px;
    color: white;
    font-family: 'Press Start 2P', monospace;
    z-index: 1100;
    min-width: 300px;
    box-shadow: 0 0 20px rgba(255,102,51,0.3); /* Changed from rgba(51, 102, 255, 0.3) */
  }

  .player-stats-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    border-bottom: 2px solid #ff6633; /* Changed from #3366ff */
    padding-bottom: 10px;
  }

  .player-stats-close {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
  }

  .player-stats-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .stat-item {
    display: flex;
    justify-content: space-between;
    padding: 5px;
    border-bottom: 1px solid rgba(255, 102, 51, 0.3); /* Changed from rgba(51, 102, 255, 0.3) */
  }

  /* Coin styles */
  .coin {
    width: 15px;
    height: 15px;
    background: #ffd700;
    border-radius: 50%;
    position: absolute;
    transform-style: preserve-3d;
    transform: translate(-50%, -50%) translateZ(10px);
    box-shadow: 0 0 10px rgba(255,215,0,0.5);
    animation: coinFloat 1s ease-in-out infinite;
  }

  @keyframes coinFloat {
    0%, 100% { transform: translate(-50%, -50%) translateZ(10px); }
    50% { transform: translate(-50%, -50%) translateZ(15px); }
  }

  /* Loading indicator styles */
  .upload-loading {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px;
    background: rgba(255, 102, 51, 0.1); /* Changed from rgba(51, 102, 255, 0.1) */
    border-radius: 5px;
    margin: 5px 0;
    font-size: 12px;
    animation: pulse 1.5s infinite;
  }

  .upload-loading::before {
    content: '';
    width: 12px;
    height: 12px;
    border: 2px solid #ff6633; /* Changed from #3366ff */
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  @keyframes pulse {
    0% { opacity: 0.6; }
    50% { opacity: 1; }
    100% { opacity: 0.6; }
  }

  /* Updated styles for version text */
  .version-text {
    position: fixed;
    bottom: 70px; /* Positioned above the "like" text */
    left: 20px;
    padding: 15px 25px;
    background: linear-gradient(45deg, #ff6633, #ff3366);
    border: 3px solid;
    border-image: linear-gradient(45deg, #ff6633, #ff3366) 1;
    border-radius: 12px;
    color: #fff;
    font-family: 'Press Start 2P', monospace;
    font-size: 16px;
    text-shadow: 
      0 0 10px rgba(255,102,51,0.8),
      0 0 20px rgba(255,51,102,0.5);
    box-shadow: 
      0 0 25px rgba(255,102,51,0.3),
      inset 0 0 15px rgba(255,51,102,0.2);
    backdrop-filter: blur(5px);
    animation: versionFloat 3s ease-in-out infinite,
               versionGlow 2s ease-in-out infinite,
               versionRotate 6s linear infinite;
    transform-style: preserve-3d;
  }

  @keyframes versionFloat {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-10px) rotate(2deg); }
    50% { transform: translateY(-15px) rotate(-2deg); }
    75% { transform: translateY(-5px) rotate(1deg); }
  }

  @keyframes versionGlow {
    0%, 100% { text-shadow: 0 0 10px rgba(255,102,51,0.8), 0 0 20px rgba(255,51,102,0.5); }
    50% { text-shadow: 0 0 20px rgba(255,102,51,1), 0 0 30px rgba(255,51,102,0.8); }
  }

  @keyframes versionRotate {
    0% { background: linear-gradient(45deg, #ff6633, #ff3366); }
    50% { background: linear-gradient(225deg, #ff6633, #ff3366); }
    100% { background: linear-gradient(405deg, #ff6633, #ff3366); }
  }

  .ad-warning {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    flex-direction: column;  /* Changed to column to stack elements */
    justify-content: center;
    align-items: center;
    color: #ff3366;
    font-family: 'Press Start 2P', monospace;
    font-size: 24px;
    text-align: center;
    padding: 20px;
    z-index: 9999;
    animation: warningFade 20s forwards;
    pointer-events: none;
  }

  /* Close panel if clicking outside */
  window.addEventListener('click', (e) => {
    if (e.target === adminPanel) {
      adminPanel.style.display = 'none';
    }
  });
</style>
</head>
<body>

<div class="title-container">
  <h1 class="title">Multiplayer Hangout Baseplate</h1>
</div>

<div class="baseplate">
  <div class="grid" id="pixelGrid"></div>
  <div class="player" id="player"></div>
</div>

<div class="money-display">Coins: <span id="coinCount">0</span></div>

<div class="player-sidebar">
  <div>Players Online: <span id="playerCount">1</span></div>
  <ul class="player-list" id="playerList"></ul>
</div>

<div class="audio-controls">
  <button class="audio-btn" id="playButton">Play 2am</button>
  <button class="audio-btn" id="pauseButton">Pause</button>
</div>

<button id="toggleMobile">Toggle Mobile Controls</button>
<button id="adminPanelBtn" class="admin-panel-btn">Admin Panel</button>

<div id="adminPanel" class="admin-panel">
  <h2>Admin Panel</h2>
  <button class="admin-panel-close" id="closeAdminPanel">×</button>
  <div id="adminControls">
    <div class="admin-user-list">
      <div class="admin-section-title">Select a user to modify coins:</div>
      <div id="adminUserList" class="admin-user-selection"></div>
    </div>
    <button id="addCoinsBtn" class="admin-btn">Add 100 Coins</button>
    <button id="removeCoinsBtn" class="admin-btn">Remove 100 Coins</button>
  </div>
</div>

<div class="mobile-controls" id="mobileControls">
  <button class="mobile-btn" id="upBtn" 
    ontouchstart="handleTouchStart(event, 'up')" 
    ontouchend="handleTouchEnd(event, 'up')">↑</button>
  <button class="mobile-btn" id="leftBtn" 
    ontouchstart="handleTouchStart(event, 'left')" 
    ontouchend="handleTouchEnd(event, 'left')">←</button>
  <button class="mobile-btn" id="downBtn" 
    ontouchstart="handleTouchStart(event, 'down')" 
    ontouchend="handleTouchEnd(event, 'down')">↓</button>
  <button class="mobile-btn" id="rightBtn" 
    ontouchstart="handleTouchStart(event, 'right')" 
    ontouchend="handleTouchEnd(event, 'right')">→</button>
  <button class="mobile-btn" id="dashBtn" 
    ontouchstart="handleDashTouch(event)"
    ontouchend="handleTouchEnd(event, 'dash')">DASH</button>
</div>

<div class="controls">
  Use WASD or Arrow Keys to move. Press Z to dash!
</div>

<!-- Chat Container -->
<div class="chat-container">
  <button class="chat-shop-btn" id="openShop">Chat Shop</button>
  <div class="chat-messages" id="chatMessages"></div>
  <div class="chat-input-container">
    <button class="file-upload-btn" id="fileUploadBtn">+</button>
    <input type="file" id="fileInput" class="file-input" accept="image/*,video/*,audio/*" style="display: none;">
    <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." maxlength="100">
    <button class="chat-send" id="chatSend">Send</button>
  </div>
</div>

<!-- Chat Shop -->
<div class="chat-shop" id="chatShop" style="display: none;">
  <div class="shop-header">
    <h2>Chat Shop</h2>
    <button class="shop-close" id="closeShop">×</button>
  </div>
  <div class="shop-items" id="shopItems">
    <!-- Items will be populated by JS -->
  </div>
</div>

<audio id="backgroundMusic" src="2am..mp3" loop></audio>
<audio id="notificationSound" src="Notification (1).mp3"></audio>

<div class="player-stats-modal" id="playerStatsModal">
  <div class="player-stats-header">
    <h2>Player Stats</h2>
    <button class="player-stats-close" id="closePlayerStats">×</button>
  </div>
  <div class="player-stats-content" id="playerStatsContent">
    <!-- Stats will be populated by JS -->
  </div>
</div>

<div class="version-text">Version 100</div>

<script>
const room = new WebsimSocket();
const players = new Map(); // Store other player elements
let initialized = false;
const sessionStartTime = Date.now(); // Move this here

const grid = document.getElementById('pixelGrid');
const player = document.getElementById('player');
const mobileControls = document.getElementById('mobileControls');
const toggleMobile = document.getElementById('toggleMobile');
const playButton = document.getElementById('playButton');
const pauseButton = document.getElementById('pauseButton');
const backgroundMusic = document.getElementById('backgroundMusic');
const notificationSound = document.getElementById('notificationSound'); // Notification sound

// Add these DOM element references at the start of the script
const shopDiv = document.getElementById('chatShop');
const shopItemsDiv = document.getElementById('shopItems');
const openShopBtn = document.getElementById('openShop');
const closeShopBtn = document.getElementById('closeShop');
const adminPanelBtn = document.getElementById('adminPanelBtn');
const adminPanel = document.getElementById('adminPanel');
const closeAdminPanel = document.getElementById('closeAdminPanel');

// Coin variables
let coins = new Map(); // Track active coins
let playerCoins = 0;

// Money variables
let ownedItems = new Set();
let equippedItem = null;

// Chat functionality
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');

// Add event listeners for chat functionality
chatInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    sendMessage();
  }
});

chatSend.addEventListener('click', sendMessage);

// File upload handling
const fileUploadBtn = document.getElementById('fileUploadBtn');
const fileInput = document.getElementById('fileInput');

// Add this function to detect advertisements
function isAdvertisement(message) {
  const adKeywords = [
    'check out my',
    'play my',
    'join my',
    'visit my',
    'play at',
    'join at',
    'my game',
    'my project',
    'my websim',
    '.com',
    '.net',
    '.io',
    'http',
    'https'
  ];
  
  return adKeywords.some(keyword => 
    message.toLowerCase().includes(keyword.toLowerCase())
  );
}

fileUploadBtn.addEventListener('click', () => {
  fileInput.click();
});

fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  // Create loading message
  const loadingMsg = document.createElement('div');
  loadingMsg.className = 'upload-loading';
  loadingMsg.textContent = `Uploading ${file.name}...`;
  chatMessages.appendChild(loadingMsg);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  try {
    // Upload to blob storage
    const url = await websim.upload(file);
    
    // Remove loading message
    loadingMsg.remove();
    
    // Send message with attachment
    room.send({
      type: 'chat',
      message: '', // Empty message for attachments
      attachment: {
        url,
        type: file.type,
        name: file.name
      }
    });

    // Add message locally
    addMessage(room.party.client.username, '', {
      url,
      type: file.type,
      name: file.name
    });

    // Clear input
    fileInput.value = '';
  } catch (error) {
    // Update loading message to show error
    loadingMsg.textContent = `Failed to upload ${file.name}`;
    loadingMsg.style.color = '#ff3366';
    setTimeout(() => loadingMsg.remove(), 3000);
    console.error('Error uploading file:', error);
  }
});

// Define shop items before they're used
const shopItems = [
  {
    id: 'rainbow',
    name: 'Rainbow Text',
    price: 100,
    style: {
      background: 'linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet)',
      '-webkit-background-clip': 'text',
      '-webkit-text-fill-color': 'transparent',
      'font-weight': 'bold'
    }
  },
  {
    id: 'neon',
    name: 'Neon Text',
    price: 200,
    style: {
      'color': '#fff',
      'text-shadow': '0 0 5px #fff, 0 0 10px #fff, 0 0 15px #0073e6, 0 0 20px #0073e6',
      'font-weight': 'bold'
    }
  },
  {
    id: 'pixel',
    name: 'Pixel Text',
    price: 300,
    style: {
      'font-family': '"Press Start 2P", monospace',
      'color': '#ff6633', /* Changed from #3366ff */
      'text-shadow': '2px 2px 0px #000',
      'font-size': '0.8em'
    }
  }
];

// Function to update the shop display
function updateShop() {
  shopItemsDiv.innerHTML = '';
  shopItems.forEach(item => {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'shop-item';
    if (ownedItems.has(item.id)) {
      itemDiv.classList.add('owned');
    }
    
    const previewSpan = document.createElement('span');
    previewSpan.className = 'preview-text';
    previewSpan.textContent = 'Sample Text';
    Object.assign(previewSpan.style, item.style);
    
    const itemInfo = document.createElement('div');
    itemInfo.innerHTML = `
      ${item.name}<br>
      ${ownedItems.has(item.id) ? 'OWNED' : `${item.price} coins`}
    `;
    
    const buyButton = document.createElement('button');
    buyButton.className = 'buy';
    buyButton.textContent = ownedItems.has(item.id) ? 'OWNED' : 'BUY';
    buyButton.disabled = !ownedItems.has(item.id) && playerCoins < item.price;
    
    const equipButton = document.createElement('button');
    equipButton.className = 'equip';
    equipButton.textContent = equippedItem === item.id ? 'EQUIPPED' : 'EQUIP';
    if (equippedItem === item.id) {
      equipButton.classList.add('equipped');
    }
    
    itemDiv.appendChild(previewSpan);
    itemDiv.appendChild(itemInfo);
    if (!ownedItems.has(item.id)) {
      itemDiv.appendChild(buyButton);
    } else {
      itemDiv.appendChild(equipButton);
    }
    
    // Add event listeners for buy/equip buttons
    buyButton.addEventListener('click', () => {
      if (playerCoins >= item.price) {
        playerCoins -= item.price;
        ownedItems.add(item.id);
        document.getElementById('coinCount').textContent = playerCoins;
        savePlayerData();
        updateShop();
      }
    });
    
    equipButton.addEventListener('click', () => {
      equippedItem = equippedItem === item.id ? null : item.id;
      savePlayerData();
      updateShop();
    });
    
    shopItemsDiv.appendChild(itemDiv);
  });
}

// Add shop toggle event listeners
openShopBtn.addEventListener('click', () => {
  shopDiv.style.display = 'block';
});

closeShopBtn.addEventListener('click', () => {
  shopDiv.style.display = 'none';
});

// Admin panel functionality
adminPanelBtn.addEventListener('click', () => {
  // Check if the current user is Shelly334
  if (room.party.client.username === 'Shelly334') {
    adminPanel.style.display = 'block';
  } else {
    // Add a visual/audio feedback that this is admin-only
    const notAllowed = document.createElement('div');
    notAllowed.style.cssText = `
      position: fixed;
      bottom: 60px;
      right: 20px;
      color: #ff3366;
      font-family: 'Press Start 2P', monospace;
      font-size: 12px;
      padding: 10px;
      background: rgba(26, 26, 26, 0.9);
      border: 2px solid #ff3366;
      border-radius: 5px;
      animation: fadeOut 2s forwards;
    `;
    notAllowed.textContent = 'Admin access only!';
    document.body.appendChild(notAllowed);

    // Play error sound
    notificationSound.play();

    // Remove the message after animation
    setTimeout(() => notAllowed.remove(), 2000);
  }
});

closeAdminPanel.addEventListener('click', () => {
  adminPanel.style.display = 'none';
});

// Only add event listeners for coin management if the user is Shelly334
if (room.party.client.username === 'Shelly334') {
  const addCoinsBtn = document.getElementById('addCoinsBtn');
  const removeCoinsBtn = document.getElementById('removeCoinsBtn');
  const adminUserList = document.getElementById('adminUserList');
  let selectedUser = null;

  // Function to update user list in admin panel
  function updateAdminUserList() {
    adminUserList.innerHTML = '';
    Object.entries(room.party.peers).forEach(([clientId, peer]) => {
      const userItem = document.createElement('div');
      userItem.className = 'admin-user-item';
      userItem.textContent = peer.username;
      
      userItem.addEventListener('click', () => {
        // Remove selected class from all items
        document.querySelectorAll('.admin-user-item').forEach(item => {
          item.classList.remove('selected');
        });
        // Add selected class to clicked item
        userItem.classList.add('selected');
        selectedUser = peer.username;
      });
      
      adminUserList.appendChild(userItem);
    });
  }

  // Update user list when admin panel is opened
  adminPanelBtn.addEventListener('click', updateAdminUserList);

  // Update the addCoinsBtn event listener for better feedback
  addCoinsBtn.addEventListener('click', async () => {
    const selectedListItem = document.querySelector('.player-list li.selected');
    if (!selectedListItem) {
      const feedback = document.createElement('div');
      feedback.textContent = 'Please select a user first!';
      feedback.style.cssText = `
        color: #ff3366;
        margin: 10px 0;
        text-align: center;
        font-size: 12px;
        animation: fadeIn 0.3s ease;
      `;
      document.getElementById('adminControls').appendChild(feedback);
      setTimeout(() => feedback.remove(), 2000);
      return;
    }

    const selectedUsername = selectedUser;
    const userData = await room.store.get(selectedUsername);
    const currentCoins = userData?.coins || 0;
    
    await room.store.update({
      id: selectedUsername,
      dependencies: { currentCoins },
      updateFunction: (data) => ({
        ...data,
        coins: currentCoins + 100
      })
    });

    const feedback = document.createElement('div');
    feedback.innerHTML = `<span style="color: #33ff66">✓</span> Added 100 coins to ${selectedUsername}!`;
    feedback.style.cssText = `
      color: #33ff66;
      margin: 10px 0;
      text-align: center;
      font-size: 12px;
      animation: fadeIn 0.3s ease;
    `;
    document.getElementById('adminControls').appendChild(feedback);
    setTimeout(() => feedback.remove(), 2000);

    notificationSound.play();
  });

  removeCoinsBtn.addEventListener('click', async () => {
    const selectedListItem = document.querySelector('.player-list li.selected');
    if (!selectedListItem) {
      const feedback = document.createElement('div');
      feedback.textContent = 'Please select a user first!';
      feedback.style.cssText = `
        color: #ff3366;
        margin: 10px 0;
        text-align: center;
        font-size: 12px;
      `;
      document.getElementById('adminControls').appendChild(feedback);
      setTimeout(() => feedback.remove(), 2000);
      return;
    }

    const selectedUsername = selectedUser;
    const userData = await room.store.get(selectedUsername);
    const currentCoins = userData?.coins || 0;
    
    await room.store.update({
      id: selectedUsername,
      dependencies: { currentCoins },
      updateFunction: (data) => ({
        ...data,
        coins: Math.max(0, currentCoins - 100)
      })
    });

    const feedback = document.createElement('div');
    feedback.textContent = `-100 coins removed from ${selectedUsername}!`;
    feedback.style.cssText = `
      color: #ff3366;
      margin: 10px 0;
      text-align: center;
      font-size: 12px;
    `;
    document.getElementById('adminControls').appendChild(feedback);
    setTimeout(() => feedback.remove(), 2000);
  });
}

// Close panel if clicking outside
window.addEventListener('click', (e) => {
  if (e.target === adminPanel) {
    adminPanel.style.display = 'none';
  }
});

// Add this function before the WebSocket message handlers
function updatePlayerList() {
  const playerList = document.getElementById('playerList');
  playerList.innerHTML = ''; // Clear current list

  // Add all peers including current client to the list
  Object.entries(room.party.peers).forEach(([clientId, peer]) => {
    const listItem = document.createElement('li');
    listItem.textContent = peer.username;
    
    // Add online indicator and style
    listItem.style.display = 'flex';
    listItem.style.alignItems = 'center';
    listItem.style.gap = '8px';
    
    const onlineIndicator = document.createElement('span');
    onlineIndicator.style.width = '8px';
    onlineIndicator.style.height = '8px';
    onlineIndicator.style.backgroundColor = '#33ff66';
    onlineIndicator.style.borderRadius = '50%';
    onlineIndicator.style.display = 'inline-block';
    
    listItem.prepend(onlineIndicator);

    // Add click handler
    listItem.addEventListener('click', () => {
      // Remove selected class from all items
      document.querySelectorAll('.player-list li').forEach(item => {
        item.classList.remove('selected');
      });
      // Add selected class to clicked item
      listItem.classList.add('selected');
      selectedUser = peer.username;
    });
    
    playerList.appendChild(listItem);
  });

  // Update player count
  const playerCount = document.getElementById('playerCount');
  if (playerCount) {
    playerCount.textContent = Object.keys(room.party.peers).length;
  }
}

function sendMessage() {
  const message = chatInput.value.trim();
  if (message) {
    if (isAdvertisement(message)) {
      // Show warning overlay
      const warning = document.createElement('div');
      warning.className = 'ad-warning';
      
      // Add main warning text
      const warningText = document.createElement('div');
      warningText.textContent = "Please don't try to advertise your game here unless you have permission u stupid dickhead";
      warning.appendChild(warningText);
      
      // Add timer
      const timer = document.createElement('div');
      timer.className = 'warning-timer';
      warning.appendChild(timer);
      
      document.body.appendChild(warning);
      
      // Start countdown
      let timeLeft = 20;
      const countdown = setInterval(() => {
        timer.textContent = `Message will disappear in ${timeLeft} seconds`;
        timeLeft--;
        
        if (timeLeft < 0) {
          clearInterval(countdown);
          warning.remove();
        }
      }, 1000);
      
      // Send modified message
      room.send({
        type: 'chat',
        message: "i tried to advertise my game I'm a dickhead! 🤪"
      });
      
      addMessage(room.party.client.username, "i tried to advertise my game I'm a dickhead! 🤪");
    } else {
      // Get equipped item style if any
      let messageStyle = null;
      if (equippedItem) {
        const item = shopItems.find(i => i.id === equippedItem);
        if (item) {
          messageStyle = item.style;
        }
      }

      // Send message with style info
      room.send({
        type: 'chat',
        message: message,
        style: messageStyle
      });
      
      addMessage(room.party.client.username, message, null, messageStyle);
    }
    chatInput.value = '';
  }
}

// Update addMessage function to handle styles
function addMessage(username, message, attachment = null, style = null) {
  const messageElement = document.createElement('div');
  messageElement.className = 'chat-message';
  
  // Create header with avatar and username
  const messageHeader = document.createElement('div');
  messageHeader.className = 'message-header';
  
  const avatar = document.createElement('img');
  avatar.className = 'chat-avatar';
  const userPeer = Object.entries(room.party.peers).find(([_, peer]) => peer.username === username);
  avatar.src = userPeer ? userPeer[1].avatarUrl : 'https://via.placeholder.com/25';
  avatar.alt = `${username}'s avatar`;
  avatar.width = 25;
  avatar.height = 25;
  
  const usernameSpan = document.createElement('span');
  usernameSpan.className = 'chat-username';
  usernameSpan.textContent = username + ':';
  
  messageHeader.appendChild(avatar);
  messageHeader.appendChild(usernameSpan);
  messageElement.appendChild(messageHeader);
  
  // Create content container
  const contentContainer = document.createElement('div');
  contentContainer.className = 'message-content';
  
  if (message) {
    const messageText = document.createElement('span');
    messageText.textContent = message;
    
    // Apply style if provided
    if (style) {
      Object.assign(messageText.style, style);
    }
    
    contentContainer.appendChild(messageText);
  }

  // Add attachment if present
  if (attachment) {
    if (attachment.type.startsWith('image/')) {
      const img = document.createElement('img');
      img.src = attachment.url;
      img.className = 'attachment';
      img.alt = attachment.name;
      contentContainer.appendChild(img);
    } else if (attachment.type.startsWith('video/')) {
      const video = document.createElement('video');
      video.src = attachment.url;
      video.className = 'attachment';
      video.controls = true;
      contentContainer.appendChild(video);
    } else {
      const link = document.createElement('a');
      link.href = attachment.url;
      link.className = 'attachment';
      link.textContent = `📎 ${attachment.name}`;
      link.target = '_blank';
      contentContainer.appendChild(link);
    }
  }
  
  messageElement.appendChild(contentContainer);
  chatMessages.appendChild(messageElement);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  // Play notification sound for new messages
  if (username !== 'System') {
    notificationSound.currentTime = 0;
    notificationSound.play();
  }
}

// Update the WebSocket message handler to handle style info
room.onmessage = (event) => {
  const data = event.data;
  switch (data.type) {
    case 'connected':
      addMessage('System', `${data.username} joined the room`);
      updatePlayerList();
      break;
    case 'disconnected':
      addMessage('System', `${data.username} left the room`);
      // Clean up disconnected player's character
      if (players.has(data.clientId)) {
        const playerElement = players.get(data.clientId);
        playerElement.remove(); // Remove the DOM element
        players.delete(data.clientId); // Remove from players Map
      }
      updatePlayerList();
      break;
    case 'chat':
      if (data.clientId !== room.party.client.id) {
        addMessage(data.username, data.message, data.attachment, data.style);
      }
      break;
    case 'playerMove':
      // Handle other player movement
      if (data.clientId !== room.party.client.id) {
        let playerElement = players.get(data.clientId);
        if (!playerElement) {
          playerElement = document.createElement('div');
          playerElement.className = 'other-player';
          
          // Add username label for other players
          const usernameLabel = document.createElement('div');
          usernameLabel.className = 'player-username';
          usernameLabel.textContent = data.username;
          playerElement.appendChild(usernameLabel);
          
          document.querySelector('.baseplate').appendChild(playerElement);
          players.set(data.clientId, playerElement);
        }
        playerElement.style.left = `${data.x}px`;
        playerElement.style.top = `${data.y}px`;
      }
      break;
    case 'coinSpawn':
      if (data.clientId !== room.party.client.id && !coins.has(data.coinId)) {
        const coin = document.createElement('div');
        coin.className = 'coin';
        coin.style.left = `${data.x}px`;
        coin.style.top = `${data.y}px`;
        document.querySelector('.baseplate').appendChild(coin);
        coins.set(data.coinId, {element: coin, x: data.x, y: data.y});
      }
      break;
      
    case 'coinCollect':
      if (data.clientId !== room.party.client.id && coins.has(data.coinId)) {
        const coin = coins.get(data.coinId);
        coin.element.remove();
        coins.delete(data.coinId);
      }
      break;
  }
};

// Also modify onPeersChanged to cleanup any stale players
room.onPeersChanged = (peers) => {
  // Remove any players that are no longer in the peers list
  players.forEach((playerElement, clientId) => {
    if (!peers[clientId]) {
      playerElement.remove();
      players.delete(clientId);
    }
  });
  updatePlayerList();
};

// Add this function before the startGame function
function updatePlayerPosition() {
  // Update player element position
  player.style.left = `${playerPos.x}px`;
  player.style.top = `${playerPos.y}px`;

  // Broadcast position to other players
  room.send({
    type: 'playerMove',
    x: playerPos.x,
    y: playerPos.y,
    echo: false // Don't send back to self
  });
}

// Start the game loop after everything is initialized
function startGame() {
  updatePlayerPosition();
  gameLoop();
}

// Add this before the gameLoop function
function gameLoop() {
  // Apply acceleration based on key states
  if (!isDashing) { // Only apply normal movement if not dashing
    if (keys.up) velocity.y -= acceleration;
    if (keys.down) velocity.y += acceleration;
    if (keys.left) velocity.x -= acceleration;
    if (keys.right) velocity.x += acceleration;
  }

  // Apply friction (reduced during dash)
  velocity.x *= isDashing ? 0.95 : friction;
  velocity.y *= isDashing ? 0.95 : friction;

  // Update position with boundaries
  playerPos.x = Math.max(20, Math.min(380, playerPos.x + velocity.x));
  playerPos.y = Math.max(20, Math.min(380, playerPos.y + velocity.y));

  // Check for coin collection
  checkCoinCollection();

  // Update player position
  updatePlayerPosition();

  // Continue game loop
  requestAnimationFrame(gameLoop);
}

// Call startGame after WebSocket connection is established
room.onopen = async () => {
  await initializePlayerData();
  startGame();
};

// Check coins collection
function checkCoinCollection() {
  coins.forEach((coin, coinId) => {
    const dx = playerPos.x - coin.x;
    const dy = playerPos.y - coin.y;
    const distance = Math.sqrt(dx * dx + dy * dy);
    
    // Increased collection radius from 25 to 35 for more reliable collection
    if (distance < 35) { // Larger collection radius
      // Add a small delay to ensure position sync
      setTimeout(() => {
        collectCoin(coinId);
      }, 50);
    }
  });
}

function collectCoin(coinId) {
  if (coins.has(coinId)) {
    try {
      const coin = coins.get(coinId);
      if (coin && coin.element) {
        coin.element.remove();
        coins.delete(coinId);
        playerCoins++;
        document.getElementById('coinCount').textContent = playerCoins;
        savePlayerData(); // Save after collecting coins
        
        room.send({
          type: 'coinCollect',
          coinId
        });
      }
    } catch (error) {
      console.error('Error collecting coin:', error);
      // Cleanup any stuck coins
      coins.delete(coinId);
    }
  }
}

// Add coin spawning interval
setInterval(spawnCoin, 3000); // Spawn attempt every 3 seconds

// Update spawnCoin function with better positioning logic
function spawnCoin() {
  if (Math.random() < 0.35 && coins.size < 3) {
    const coinId = Date.now();
    // Add padding to spawn position to prevent edge spawning
    const x = Math.random() * 320 + 40; // More centered spawn range
    const y = Math.random() * 320 + 40;
    
    try {
      const coin = document.createElement('div');
      coin.className = 'coin';
      coin.style.left = `${x}px`;
      coin.style.top = `${y}px`;
      document.querySelector('.baseplate').appendChild(coin);
      
      coins.set(coinId, {
        element: coin,
        x: x,
        y: y,
        spawnTime: Date.now() // Track when coin was spawned
      });
      
      room.send({
        type: 'coinSpawn',
        coinId,
        x,
        y
      });
    } catch (error) {
      console.error('Error spawning coin:', error);
    }
  }
}

// Add coin cleanup interval to prevent stuck coins
setInterval(() => {
  const now = Date.now();
  coins.forEach((coin, coinId) => {
    // Remove coins that have been around too long (30 seconds)
    if (now - coin.spawnTime > 30000) {
      try {
        coin.element.remove();
        coins.delete(coinId);
      } catch (error) {
        console.error('Error cleaning up old coin:', error);
      }
    }
  });
}, 5000); // Check every 5 seconds

// Audio controls
playButton.addEventListener('click', () => {
  backgroundMusic.play();
  playButton.classList.add('playing');
});

pauseButton.addEventListener('click', () => {
  backgroundMusic.pause();
  playButton.classList.remove('playing');
});

// Create grid
for(let i = 0; i < 256; i++) {
  const pixel = document.createElement('div');
  pixel.className = 'pixel';
  grid.appendChild(pixel);
}

let playerPos = {
  x: 200,
  y: 200
};

let velocity = {
  x: 0,
  y: 0
};

const speed = 2;
const acceleration = 0.4; // Increased from 0.2
const friction = 0.9; // Increased from 0.85

// Add these variables near the top with other game variables
const dashPower = 15; // How powerful the dash is
const dashCooldown = 500; // Cooldown in milliseconds
let canDash = true;
let isDashing = false;

// Add this code before the gameLoop function:
const keys = {
  up: false,
  down: false,
  left: false,
  right: false
};

// Add keyboard event listeners
window.addEventListener('keydown', (e) => {
  switch(e.key.toLowerCase()) {
    case 'w':
    case 'arrowup':
      keys.up = true;
      break;
    case 's':
    case 'arrowdown':
      keys.down = true;
      break;
    case 'a': 
    case 'arrowleft':
      keys.left = true;
      break;
    case 'd':
    case 'arrowright':
      keys.right = true;
      break;
    // Add additional dash key handler
    case 'z':
      if(canDash) performDash();
      break;
  }
});

window.addEventListener('keyup', (e) => {
  switch(e.key.toLowerCase()) {
    case 'w':
    case 'arrowup':
      keys.up = false;
      break;
    case 's':
    case 'arrowdown':
      keys.down = false;
      break;
    case 'a':
    case 'arrowleft':
      keys.left = false;
      break;
    case 'd':
    case 'arrowright':
      keys.right = false;
      break;
  }
});

// Add these new functions
function performDash() {
  if (!canDash) return;
  
  isDashing = true;
  canDash = false;

  // Calculate dash direction based on current movement
  let dashX = 0;
  let dashY = 0;
  
  if (keys.up) dashY = -dashPower;
  if (keys.down) dashY = dashPower;
  if (keys.left) dashX = -dashPower;
  if (keys.right) dashX = dashPower;
  
  // If no direction pressed, dash in last moved direction or default to right
  if (dashX === 0 && dashY === 0) {
    if (velocity.x !== 0 || velocity.y !== 0) {
      // Use normalized velocity direction
      const length = Math.sqrt(velocity.x * velocity.x + velocity.y * velocity.y);
      dashX = (velocity.x / length) * dashPower;
      dashY = (velocity.y / length) * dashPower;
    } else {
      dashX = dashPower; // Default dash right
    }
  }

  // Apply dash velocity
  velocity.x += dashX;
  velocity.y += dashY;

  // Visual feedback
  player.style.transition = 'transform 0.1s';
  player.style.transform = 'translate(-50%, -50%) translateZ(10px) scale(0.8)';

  // Reset dash state after short delay
  setTimeout(() => {
    isDashing = false;
    player.style.transform = 'translate(-50%, -50%) translateZ(10px) scale(1)';
  }, 100);

  // Start cooldown
  setTimeout(() => {
    canDash = true;
    player.style.transition = '';
  }, dashCooldown);
}

// Add mobile dash support
function handleDashTouch(event) {
  event.preventDefault();
  performDash();
}

// Add these touch handling functions after the keyboard event listeners:
function handleTouchStart(event, direction) {
  event.preventDefault();
  keys[direction] = true;
}

function handleTouchEnd(event, direction) {
  event.preventDefault();
  keys[direction] = false;
}

// Update mobile controls toggle functionality
toggleMobile.addEventListener('click', () => {
  mobileControls.classList.toggle('active');
  // Get the PC controls element
  const pcControls = document.querySelector('.controls');
  // Toggle its visibility based on mobile controls state
  if (mobileControls.classList.contains('active')) {
    pcControls.style.display = 'none';
  } else {
    pcControls.style.display = 'block';
  }
});

// Update the initialization function
async function initializePlayerData() {
  try {
    // Initialize default values
    playerCoins = 0;
    ownedItems = new Set();
    equippedItem = null;

    // Get the store data for this player
    const storeData = await room.store.get(room.party.client.username);
    
    if (storeData) {
      // Load saved data
      playerCoins = storeData.coins || 0;
      ownedItems = new Set(storeData.ownedItems || []);
      equippedItem = storeData.equippedItem || null;
    }

    // Update UI with loaded data
    document.getElementById('coinCount').textContent = playerCoins;
    
    // Make sure shop is initialized before updating it
    if (shopItemsDiv) {
      updateShop();
    }
  } catch (error) {
    console.error('Error initializing player data:', error);
  }
}

// Save player data
function savePlayerData() {
  if (!room.party.client.username) return; // Don't save if username isn't available
  
  room.store.update({
    id: room.party.client.username,
    dependencies: { 
      playerCoins,
      ownedItems: Array.from(ownedItems),
      equippedItem,
      sessionStartTime // Add sessionStartTime to dependencies
    },
    updateFunction: (data) => ({
      coins: playerCoins,
      ownedItems: Array.from(ownedItems),
      equippedItem,
      timeSpent: (data?.timeSpent || 0) + Math.floor((Date.now() - sessionStartTime) / 1000)
    })
  });
}

// Modify the onmessage handler to properly clean up disconnected players
room.onmessage = (event) => {
  const data = event.data;
  switch (data.type) {
    case 'connected':
      addMessage('System', `${data.username} joined the room`);
      updatePlayerList();
      break;
    case 'disconnected':
      addMessage('System', `${data.username} left the room`);
      // Clean up disconnected player's character
      if (players.has(data.clientId)) {
        const playerElement = players.get(data.clientId);
        playerElement.remove(); // Remove the DOM element
        players.delete(data.clientId); // Remove from players Map
      }
      updatePlayerList();
      break;
    case 'chat':
      if (data.clientId !== room.party.client.id) {
        addMessage(data.username, data.message, data.attachment, data.style);
      }
      break;
    case 'playerMove':
      // Handle other player movement
      if (data.clientId !== room.party.client.id) {
        let playerElement = players.get(data.clientId);
        if (!playerElement) {
          playerElement = document.createElement('div');
          playerElement.className = 'other-player';
          
          // Add username label for other players
          const usernameLabel = document.createElement('div');
          usernameLabel.className = 'player-username';
          usernameLabel.textContent = data.username;
          playerElement.appendChild(usernameLabel);
          
          document.querySelector('.baseplate').appendChild(playerElement);
          players.set(data.clientId, playerElement);
        }
        playerElement.style.left = `${data.x}px`;
        playerElement.style.top = `${data.y}px`;
      }
      break;
    case 'coinSpawn':
      if (data.clientId !== room.party.client.id && !coins.has(data.coinId)) {
        const coin = document.createElement('div');
        coin.className = 'coin';
        coin.style.left = `${data.x}px`;
        coin.style.top = `${data.y}px`;
        document.querySelector('.baseplate').appendChild(coin);
        coins.set(data.coinId, {element: coin, x: data.x, y: data.y});
      }
      break;
    case 'coinCollect':
      if (data.clientId !== room.party.client.id && coins.has(data.coinId)) {
        const coin = coins.get(data.coinId);
        coin.element.remove();
        coins.delete(data.coinId);
      }
      break;
  }
};

// Also modify onPeersChanged to cleanup any stale players
room.onPeersChanged = (peers) => {
  // Remove any players that are no longer in the peers list
  players.forEach((playerElement, clientId) => {
    if (!peers[clientId]) {
      playerElement.remove();
      players.delete(clientId);
    }
  });
  updatePlayerList();
};

// Add this countdown timer function
function startVersionTimer() {
  let timeLeft = 20 * 60; // 20 minutes in seconds
  const countdownElement = document.getElementById('countdown');
  
  const timer = setInterval(() => {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    
    // Format with leading zeros
    countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    if (timeLeft <= 0) {
      clearInterval(timer);
      // Add celebration message
      const celebration = document.createElement('div');
      celebration.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(45deg, #ff6633, #ff3366);
        padding: 20px;
        border-radius: 10px;
        color: white;
        font-family: 'Press Start 2P';
        text-align: center;
        z-index: 1000;
        animation: celebrateIn 0.5s ease-out;
      `;
      celebration.innerHTML = `
        <h2>🎮 Version 80 is Here! 🎮</h2>
        <p>Refresh the page to play the new version!</p>
      `;
      document.body.appendChild(celebration);
    }
    
    timeLeft--;
  }, 1000);
}

// Call the timer start function after WebSocket connection
room.onopen = async () => {
  await initializePlayerData();
  startGame();
};

// Session start time tracking
</script>

<div class="like-text">If you like the game please leave a like for more updates!</div>
</body></html>
